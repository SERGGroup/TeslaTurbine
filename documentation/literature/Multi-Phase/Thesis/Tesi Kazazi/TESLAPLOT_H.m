%tesla comparision data
clear all
clc

%averaging step (Two lines are
%                               one for efficiency-matched set of data
%                               one for Power     -matched set of data

%%%%%%%%       PW     EFF    Flow    Pin    Pout    RPM     Ratio   quality   ma
%case 1-1
DATA(:,:,1)=[ 642.5 0.0335  0.1901  14.75   2.43    2994    0.175   0.2392  0.7725 
              813.2 0.0415  0.1901  14.75   2.42    2994    0.175   0.2392  0.9145
              641.3 0.0403  0.1901  14.75   3.22    2994    0.175   0.2392  0.6095
              662.9 0.0416  0.1901  14.75   3.22    2994    0.175   0.2392  0.6280];
%case 1-2          
DATA(:,:,2)=[ 704.7 0.0422  0.1615  13.03   2.14    3024    0.175   0.2456  0.9325 
              796.7 0.0470  0.1615  13.03   2.14    3024    0.175   0.2456  1.0220
              716.6 0.0508  0.1615  13.03   2.78    3024    0.175   0.2456  0.7906
              660.8 0.0472  0.1615  13.03   2.78    3024    0.175   0.2456  0.7345];  
%Case 1-3          
DATA(:,:,3)=[ 1114  0.0540  0.1932  15.44   2.51    3057    0.175   0.2368  1.1220 
              1225  0.0584  0.1932  15.44   2.50    3057    0.175   0.2368  1.2090
              1135  0.0661  0.1932  15.44   3.32    3057    0.175   0.2368  0.9875
              966.5 0.0576  0.1932  15.44   3.33    3057    0.175   0.2368  0.8515];  
%Case 1-4         
DATA(:,:,4)=[ 1364  0.0571  0.2236  18.84   3.06    3006    0.175   0.2254  1.1490 
              1396  0.0582  0.2236  18.84   3.06    3006    0.175   0.2254  1.1700
              1370  0.0687  0.2236  18.84   4.01    3006    0.175   0.2254  1.0110
              1140  0.0588  0.2236  18.84   4.02    3006    0.175   0.2254  0.8527];
%Case 1-5         
DATA(:,:,5)=[ 1571  0.0568  0.2599  20.96   3.39    3006    0.175   0.2190  1.1310 
              1534  0.0557  0.2599  20.96   3.39    3006    0.175   0.2190  1.1100
              1548  0.0686  0.2599  20.96   4.57    3006    0.175   0.2190  0.9674  
              1192  0.0548  0.2599  20.96   4.57    3006    0.175   0.2190  0.7604]; 
%Case 1-6         
DATA(:,:,6)=[ 1252  0.0545  0.2155  17.24   2.80    3012    0.175   0.2306  1.1240 
              1252  0.0589  0.2155  17.24   2.80    3012    0.175   0.2306  1.2090
              1249  0.0659  0.2155  17.24   3.73    3012    0.175   0.2306  0.9707
              1064  0.0574  0.2155  17.24   3.74    3012    0.175   0.2306  0.8372]; 
%Case 1-7         
DATA(:,:,7)=[ 1566  0.0555  0.2658  20.68   3.34    3012    0.175   0.2198  1.1130 
              1566  0.0555  0.2658  20.68   3.34    3012    0.175   0.2198  1.1130
              1586  0.0693  0.2658  20.68   4.57    3012    0.175   0.2198  0.9690
              1221  0.0553  0.2658  20.68   4.58    3012    0.175   0.2198  0.7615]; 
%Case 1-8         
DATA(:,:,8)=[ 1845  0.0572  0.3035  23.44   3.78    3012    0.175   0.2121  1.1230 
              1768  0.0553  0.3035  23.44   3.78    3012    0.175   0.2121  1.0870
              1864  0.0719  0.3035  23.44   5.22    3012    0.175   0.2121  0.9750
              1377  0.0555  0.3035  23.44   5.23    3012    0.175   0.2121  0.7379]; 
%Case 2-1         
DATA(:,:,9)=[ 543.8 0.0403  0.1306  10.96   1.81    2940    0.175   0.2536  0.9304 
              616.2 0.0450  0.1306  10.96   1.81    2940    0.175   0.2536  1.0230
              543.5 0.0472  0.1306  10.96   2.31    2940    0.175   0.2536  0.7844
              521.6 0.0455  0.1306  10.96   2.31    2940    0.175   0.2536  0.7556]; 
%Case 2-2         
DATA(:,:,10)=[1103  0.0549  0.1873  15.17   2.47    3000    0.175   0.2377  1.1550 
              1166  0.0575  0.1873  15.17   2.47    3000    0.175   0.2377  1.2070
              1092  0.0652  0.1873  15.17   3.25    3000    0.175   0.2377  0.9995
              932.1 0.0569  0.1873  15.17   3.25    3000    0.175   0.2377  0.8632]; 
%Case 2-3         
DATA(:,:,11)=[1555  0.0579  0.2513  20.68   3.35    3012    0.175   0.2198  1.1500 
              1526  0.0571  0.2513  20.68   3.35    3012    0.175   0.2198  1.1330
              1543  0.0699  0.2513  20.68   4.47    3012    0.175   0.2198  0.9956
              1219  0.0572  0.2513  20.68   4.47    3012    0.175   0.2198  0.8011]; 
%Case 2-4         
DATA(:,:,12)=[1883  0.0585  0.3021  23.72   3.82    3012    0.175   0.2113  1.1410 
              1712  0.0541  0.3021  23.72   3.83    3012    0.175   0.2113  1.0600
              1855  0.0717  0.3021  23.72   5.25    3012    0.175   0.2113  0.9733
              1310  0.0532  0.3021  23.72   5.26    3012    0.175   0.2113  0.7070]; 
%Case 2-5         
DATA(:,:,13)=[2073  0.0510  0.3951  29.65   4.77    3000    0.175   0.1976  0.9768 
              1852  0.0463  0.3951  29.65   4.79    3000    0.175   0.1976  0.8982
              2113  0.0656  0.3951  29.65   6.68    3000    0.175   0.1976  0.8263
              1403  0.0455  0.3951  29.65   6.70    3000    0.175   0.1976  0.5698]; 
%Case 2-6         
DATA(:,:,14)=[1989  0.0463  0.4241  30.61   4.93    3012    0.175   0.1958  0.8971 
              1776  0.0419  0.4241  30.61   4.95    3012    0.175   0.1958  0.8265
              1973  0.0588  0.4241  30.61   7.01    3012    0.175   0.1958  0.7200
              1389  0.0428  0.4241  30.61   7.02    3012    0.175   0.1958  0.5252]; 
%Case 5-1         
DATA(:,:,15)=[1296  0.0599  0.2023  16.55   2.66    3486    0.175   0.2329  1.1120 
              1296  0.0599  0.2023  16.55   2.66    3486    0.175   0.2329  1.1120
              1316  0.0733  0.2023  16.55   3.53    3486    0.175   0.2329  0.9634
              1035  0.0594  0.2023  16.55   3.54    3486    0.175   0.2329  0.7749]; 
%Case 5-2         
DATA(:,:,16)=[1891  0.0648  0.2726  22.13   3.53    3504    0.175   0.2157  1.1360 
              1730  0.0601  0.2726  22.13   3.54    3504    0.175   0.2157  1.0610
              1927  0.0810  0.2726  22.13   4.80    3504    0.175   0.2157  0.9887
              1346  0.0594  0.2726  22.13   4.81    3504    0.175   0.2157  0.7148]; 
%Case 5-3         
DATA(:,:,17)=[2367  0.0689  0.3175  25.30   4.01    3492    0.175   0.2073  1.1830 
              2086  0.0622  0.3175  25.30   4.03    3492    0.175   0.2073  1.0750
              2322  0.0847  0.3175  25.30   5.55    3492    0.175   0.2073  1.0000
              1647  0.0632  0.3175  25.30   5.56    3492    0.175   0.2073  0.7328]; 
%Case 5-4         
DATA(:,:,18)=[2750  0.0685  0.3719  28.27   4.46    3504    0.175   0.2005  1.1610 
              2311  0.0594  0.3719  28.27   4.49    3504    0.175   0.2005  1.1610
              2729  0.0865  0.3719  28.27   6.31    3504    0.175   0.2005  0.9809
              1725  0.0583  0.3719  28.27   6.33    3504    0.175   0.2005  0.6484]; 
%Case 6-1         
DATA(:,:,19)=[2858  0.0736  0.3602  28.27   4.40    4014    0.175   0.2005  1.1270 
              2492  0.0657  0.3602  28.27   4.43    4014    0.175   0.2005  1.0200
              2858  0.0933  0.3602  28.27   6.21    4014    0.175   0.2005  0.9441
              1868  0.0933  0.3602  28.27   6.23    4014    0.175   0.2005  0.6479]; 
%Case 6-2         
DATA(:,:,20)=[2439  0.0740  0.3044  24.61   3.85    4011    0.175   0.2090  1.1540 
              2129  0.0661  0.3044  24.61   3.87    4011    0.175   0.2090  1.0450
              2414  0.0917  0.3044  24.61   5.34    4011    0.175   0.2090  0.9672
              1670  0.0666  0.3044  24.61   5.35    4011    0.175   0.2090  0.6977]; 
%Case 6-3         
DATA(:,:,21)=[1891  0.0688  0.2558  20.96   3.30    4005    0.175   0.2190  1.1100 
              1718  0.0635  0.2558  20.96   3.31    4005    0.175   0.2190  1.0350
              1948  0.0870  0.2558  20.96   4.50    4005    0.175   0.2190  0.9584
              1402  0.0652  0.2558  20.96   4.51    4005    0.175   0.2190  0.7160]; 
%Case 6-4         
DATA(:,:,22)=[1539  0.0693  0.2055  17.93   2.84    3993    0.175   0.2284  1.1370 
              1539  0.0693  0.2055  17.93   2.84    3993    0.175   0.2284  1.1370
              1576  0.0848  0.2055  17.93   3.73    3993    0.175   0.2284  0.9918
              1201  0.0670  0.2055  17.93   3.73    3993    0.175   0.2284  0.7789]; 
%Case 6-5         
DATA(:,:,23)=[760.5 0.0400  0.1864  15.17   2.45    3960    0.175   0.2377  0.7713 
              760.5 0.0400  0.1864  15.17   2.45    3960    0.175   0.2377  0.7713
              773.4 0.0488  0.1864  15.17   3.22    3960    0.175   0.2377  0.5940
              633.0 0.0403  0.1864  15.17   3.22    3960    0.175   0.2377  0.5393]; 
%Case 4-1         
DATA(:,:,24)=[2739  0.0698  0.3679  27.10   4.16    4506    0.175   0.2031  1.0300 
              2600  0.0668  0.3679  27.10   4.17    4506    0.175   0.2031  0.9941
              2801  0.0925  0.3679  27.10   6.07    4506    0.175   0.2031  0.8384
              1949  0.0669  0.3679  27.10   6.08    4506    0.175   0.2031  0.6119]; 
%Case 4-2         
DATA(:,:,25)=[1826  0.0647  0.2663  20.96   3.26    4488    0.175   0.2190  1.0000 
              1826  0.0647  0.2663  20.96   3.26    4488    0.175   0.2190  1.0000
              1884  0.0834  0.2663  20.96   4.55    4488    0.175   0.2190  0.8233
              1406  0.0640  0.2663  20.96   4.56    4488    0.175   0.2190  0.6386]; 
%Case 4-3         
DATA(:,:,26)=[1391  0.0623  0.2105  17.24   2.70    4500    0.175   0.2306  0.9920 
              1311  0.0591  0.2105  17.24   2.71    4500    0.175   0.2306  0.9530
              1393  0.0762  0.2105  17.24   3.65    4500    0.175   0.2306  0.7998
              1078  0.0603  0.2105  17.24   3.65    4500    0.175   0.2306  0.6402];        
%
%
%
%Case 1-n

n=26; %update to number of cases

for i=1:n     
DATAbarH(i,:)=mean(DATA([1 2],:,i));
DATAbarS(i,:)=mean(DATA([3 4],:,i));
end
%% experimental data
%each line is for one set
%26 line:cases expected
%%%%%%%%       PW        EFF     Flow   Pin      Pout   RPM
EXP=        [ 0.648     0.041   0.419   214     14.22   2994 
              0.703     0.047   0.356   189     14.18   3024  
              1.212     0.058   0.426   224     14.14   3057
              1.362     0.058   0.493   274     14.25   3006
              1.576     0.055   0.573   304     14.26   3006
              1.246     0.058   0.475   250     14.17   3012
              1.578     0.055   0.586   300     14.18   3012
              1.840     0.055   0.669   340     14.28   3012
              0.543     0.045   0.288   159     14.14   2940
              1.100     0.057   0.413   220     14.15   3000
              1.555     0.057   0.554   300     14.20   3012
              1.887     0.054   0.666   344     14.24   3012
              2.093     0.046   0.871   430     14.29   3000
              1.960     0.042   0.935   444     14.33   3012
              1.311     0.059   0.446   240     14.42   3486
              1.926     0.060   0.601   321     14.50   3504
              2.387     0.062   0.700   367     14.50   3492
              2.700     0.059   0.820   410     14.55   3504
              2.876     0.065   0.794   410     14.58   4014
              2.400     0.066   0.671   357     14.50   4011
              1.922     0.064   0.564   304     14.51   4005
              1.570     0.068   0.453   260     14.42   3993
              0.776     0.040   0.411   220     14.40   3960
              2.786     0.067   0.811   394     14.60   4506
              1.875     0.064   0.587   304     14.51   4488
              1.383     0.060   0.464   250     14.39   4500];
EXP([1:n],1)=EXP([1:n],1)*1000;
EXP([1:n],3)=EXP([1:n],3)*0.453592;

%%

figure
subplot(2,1,1)
plot([1:n],DATAbarH([1:n],2),'r*',[1:n],EXP([1:n],2),'b-s')
xlabel('cases')  % should be updated to different parameters
ylabel('power (W)')
legend('Hmg. FLow Model','Exp data')
grid on
subplot(2,1,2)
plot([1:n],DATAbarH([1:n],1),'r*',[1:n],EXP([1:n],1),'b-s')
xlabel('cases')  % should be updated to different parameters
ylabel('\eta')
legend('Hmg. FLow Model','Exp data')
grid on

figure
PinH=DATAbarH([1:n],4)*0.175;
%PinS=DATAbarS([1:n],4)*0.175;
PoutH=DATAbarH([1:n],5);
%PoutS=DATAbarS([1:n],5);
BetaH=PinH./PoutH;
%BetaS=PinS./PoutS;
plot(BetaH,DATAbarH([1:n],1),'bsq')
xlabel('\beta')
ylabel('Power (W)')
figure
subplot(2,1,1)
i=1; j=14; R=[i:j]; % range
% plot(DATAbarH(R,3),DATAbarH(R,1),'r*',...
%     DATAbarS(R,3),DATAbarS(R,1),'g*',...
% EXP(R,3)*0.453592,EXP(R,1),'bs')
f1=fit(DATAbarH(R,3),DATAbarH(R,1),'poly1','Normalize','on','Robust','Bisquare')
%f2=fit(DATAbarS(R,3),DATAbarS(R,1),'poly1','Normalize','on','Robust','Bisquare')
hold on
%f3=fit(EXP(R,3),EXP(R,1),'poly1','Normalize','on','Robust','Bisquare')
plot(EXP(R,3),EXP(R,1),'bs')
%plot(f3,'b')
plot(f1,'r')
%plot(f2,'g')
legend('Exp data','Hmg. FLow Model')
xlabel('Flow rate (kg/s)')  % should be updated to different parameters
ylabel('power (W)')

subplot(2,1,2)
err1=[f1(EXP(R,3))-EXP(R,1)]./EXP(R,1);
%err2=[f2(EXP(R,3))-EXP(R,1)]./EXP(R,1);
bar([err1([2 3 4 5 6 7 8 9 10 11 12 13 14])]*100')
legend('Homogeneous model')
xlabel('case')  % should be updated to different parameters
ylabel('relative error')


%%
figure
i=1;j=14; R=[i:j]; % range
plot(DATAbarH(R,3),DATAbarH(R,1),'r*',...
    EXP(R,3),EXP(R,1),'b*')
hold on
i=15; j=18; R=[i:j]; % range
plot(DATAbarH(R,3),DATAbarH(R,1),'yo',...
    EXP(R,3),EXP(R,1),'bo')
i=19; j=23;R=[i:j]; % range
plot(DATAbarH(R,3),DATAbarH(R,1),'md',...    
    EXP(R,3),EXP(R,1),'bd')
i=24; j=26; R=[i:j]; % range
plot(DATAbarH(R,3),DATAbarH(R,1),'cs',...
    EXP(R,3),EXP(R,1),'bs')
legend( 'Hom. RPM3000','exp. fit RPM3000',...
        'Hom. RPM3500','exp. fit RPM3500',...
        'Hom. RPM4000','exp. fit RPM4000',...
        'Hom. RPM4500','exp. fit RPM4500')
xlabel('Flow (kg/s)')  % should be updated to different parameters
ylabel('power (W)')
grid on

%%
figure
f11=fit(DATAbarH([1:n],3),DATAbarH([1:n],2),'poly3','Normalize','on','Robust','Bisquare')
hold on
%f22=fit(DATAbarS([1:n],3),DATAbarS([1:n],2),'poly3','Normalize','on','Robust','Bisquare')
f33=fit(EXP([1:n],3),EXP([1:n],2),'poly3','Normalize','on','Robust','Bisquare')

plot(EXP([1:n],3),EXP([1:n],2),'bs')
plot(f11,'r')
%plot(f22,'g')
%plot(f33,'b')

%legend('Exp data','Hmg. FLow Model','Sep. FLow Model','exp. fit')
%Flow=[]
xlabel('flow (kg/s)')  % should be updated to different parameters
ylabel('power (W)')
legend('Exp data','Hmg. FLow Model')
grid on